<div class="container py-4">
  <div class="card border-0 shadow rounded-4 mb-4">
    <div class="card-header bg-transparent border-0 px-4 pt-4 pb-2">
      <div class="d-flex align-items-center justify-content-between">
        <div class="d-flex align-items-center gap-2">
          <h5 class="mb-0">Transactions</h5>
        </div>
        <div class="d-flex align-items-center gap-2">
          <div *ngIf="accountsLoading" class="spinner-border spinner-border-sm text-primary" role="status"></div>
          <span class="text-muted small" *ngIf="accountsLoading">Loading accounts...</span>
        </div>
      </div>
    </div>

    <div class="card-body p-4">
      <div class="row gx-3 gy-2 align-items-end">
        <div class="col-12 col-md-6">
          <label class="form-label fw-semibold">Account</label>
          <select class="form-select" [formControl]="form.controls.accountNumber">
            <option *ngFor="let a of accounts" [value]="a.accountNumber">
              {{ a.accountTypeName }} • A/C {{ a.accountNumber }}
            </option>
          </select>
          <div class="text-danger small mt-2" *ngIf="accountsError">{{ accountsError }}</div>
        </div>

        <div class="col-12 col-md-6 d-flex justify-content-md-end align-items-center">
          <div class="d-flex align-items-center gap-2">
            <span class="text-muted small">Per page</span>
            <select class="form-select form-select-sm" style="width: auto" [(ngModel)]="pageSize" (ngModelChange)="setPage(1)">
              <option [value]="10">10</option>
              <option [value]="20">20</option>
              <option [value]="50">50</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <div *ngIf="txLoading" class="px-4 pb-4 d-flex align-items-center gap-2">
      <div class="spinner-border text-primary" role="status" aria-hidden="true"></div>
      <span class="text-muted">Loading transactions...</span>
    </div>

    <div *ngIf="!txLoading && txError" class="alert alert-danger mx-4 mb-4">
      {{ txError }}
    </div>

    <div *ngIf="!txLoading && !txError && pagedTransactions.length" class="list-group list-group-flush">
      <div
        *ngFor="let t of pagedTransactions"
        class="list-group-item bg-white border-0 border-top d-flex align-items-center justify-content-between px-4 py-3"
      >
        <div class="me-3 flex-grow-1">
          <div class="d-flex align-items-center flex-wrap gap-2">
            <span class="fw-semibold">{{ t.transactionType }}</span>
            <span class="text-muted">•</span>
            <span class="small text-muted">{{ t.transactionDate | date:'medium' }}</span>

            <span class="badge rounded-pill"
                  [ngClass]="{
                    'bg-success': t.isSuccess && !t.isVerificationRequired,
                    'bg-warning text-dark': t.isVerificationRequired && !t.isSuccess,
                    'bg-secondary': !t.isSuccess && !t.isVerificationRequired
                  }">
              {{ t.isVerificationRequired ? 'Pending' : (t.isSuccess ? 'Success' : 'Failed') }}
            </span>

            <span class="badge rounded-pill"
                  [ngClass]="isCredit(t, form.value.accountNumber!) ? 'bg-success' : 'bg-secondary'">
              {{ isCredit(t, form.value.accountNumber!) ? 'Credit' : 'Debit' }}
            </span>
          </div>

          <div class="small text-muted mt-1">
            Ref: {{ t.referenceNumber || '—' }} || Amount : {{t.amount}}
          </div>

          <div class="small mt-1"
               [ngClass]="isCredit(t, form.value.accountNumber!) ? 'text-success' : 'text-danger'">
            {{ isCredit(t, form.value.accountNumber!) ? 'Credit' : 'Debit' }}
            • From {{ t.fromAccount }} ({{ t.fromUser }}) → To {{ t.toAccount }} ({{ t.toUser }})
          </div>

          <div class="small text-muted mt-1" *ngIf="t.errorMessage && !t.isSuccess">
            {{ t.errorMessage }}
          </div>
        </div>

        <div class="text-end small text-muted">
          <div>From: {{ t.fromAccount }}</div>
          <div>To: {{ t.toAccount }}</div>
        </div>
      </div>
    </div>

    <div *ngIf="!txLoading && !txError && !pagedTransactions.length" class="px-4 pb-4">
      <div class="text-muted">No transactions found for the selected account.</div>
    </div>

    <div class="card-footer bg-transparent border-0 px-4 pb-4 pt-3" *ngIf="!txLoading && !txError && transactions.length">
      <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
        <div class="text-muted small">
          Page {{ page }} of {{ totalPages }} • {{ transactions.length }} total
        </div>
        <nav aria-label="Transactions pages">
          <ul class="pagination mb-0">
            <li class="page-item" [class.disabled]="page === 1">
              <button class="page-link" (click)="setPage(1)" aria-label="First">«</button>
            </li>
            <li class="page-item" [class.disabled]="page === 1">
              <button class="page-link" (click)="setPage(page - 1)" aria-label="Previous">‹</button>
            </li>

            <li class="page-item" *ngFor="let p of [].constructor(totalPages); let i = index"
                [class.active]="(i + 1) === page">
              <button class="page-link" (click)="setPage(i + 1)">{{ i + 1 }}</button>
            </li>

            <li class="page-item" [class.disabled]="page === totalPages">
              <button class="page-link" (click)="setPage(page + 1)" aria-label="Next">›</button>
            </li>
            <li class="page-item" [class.disabled]="page === totalPages">
              <button class="page-link" (click)="setPage(totalPages)" aria-label="Last">»</button>
            </li>
          </ul>
        </nav>
      </div>
    </div>
  </div>
</div>
